# Проект: Анализ сайта «СберАвтоподписка»

## Содержание

- [О компании и продукте](#о-компании-и-продукте)
- [Постановка задачи](#постановка-задачи)
- [Описание данных](#описание-данных)
- [Подготовка данных](#подготовка-данных)
- [Разведывательный анализ (EDA)](#разведывательный-анализ-eda)
- [Подготовка данных к моделированию](#подготовка-данных-к-моделированию)
- [Моделирование](#моделирование)
- [Оценка качества модели](#оценка-качества-модели)
- [Интерпретация важности признаков (фичей)](#интерпретация-важности-признаков-фичей)
- [Результаты и рекомендации](#результаты-и-рекомендации)
- [Использованные библиотеки](#использованные-библиотеки)
- [Лицензия](#лицензия)
- [Инструкция по использованию](#инструкция-по-использованию)
- [Приложения](#приложения)

## О компании и продукте

**СберАвтоподписка** – это сервис долгосрочной аренды автомобилей для физических лиц. Клиент платит фиксированную сумму в месяц и получает автомобиль в пользование на срок от 6 месяцев до 3 лет.

В стоимость включены:
- Страхование (КАСКО, ОСАГО, ДСАГО);
- Техническое обслуживание и ремонт;
- Сезонная смена и хранение шин;
- Круглосуточная поддержка.

Сервис ориентирован на пользователей, которые хотят пользоваться автомобилем без необходимости его покупки, переплат по кредиту и заботы о ремонте.

---

## Постановка задачи

**Цель проекта** – создать модель бинарной классификации, предсказывающую вероятность того, что пользователь совершит **целевое действие** на сайте.

### Целевое действие
Ключевые события, свидетельствующие о проявлении интереса к продукту:
- `sub_submit_success` – отправка заявки;
- `callback_requested`, `sub_callback_submit_click` – заказ звонка;
- `chat_requested`, `client_initiate_chat` – начало чата;
- `click_buy_auto` – выбор автомобиля;
- `sub_open_dialog_click`, `calculate` – открытие диалога или калькулятора.

### Ожидаемый результат
- Модель с **ROC-AUC > 0.65**;
- Рекомендации по:
  - оценке эффективности каналов привлечения трафика;
  - адаптации рекламных кампаний;
  - улучшению UX сайта за счет анализа поведения пользователей.

---

## Описание данных

Проект основан на двух датасетах:

### 1. `ga_sessions.csv` – информация о сессиях
- **Размер**: 1 860 042 строк, 18 столбцов.
- **Одна строка = один визит на сайт**.

#### Ключевые атрибуты:

| Поле | Описание |
|------|--------|
| `session_id` | Уникальный идентификатор сессии |
| `client_id` | Уникальный идентификатор пользователя |
| `visit_date` | Дата визита |
| `visit_time` | Время визита |
| `visit_number` | Номер визита пользователя (1 — первый) |
| `utm_source` | Источник трафика (например, yandex, google) |
| `utm_medium` | Тип трафика (cpc, banner, email и т.д.) |
| `utm_campaign` | Название рекламной кампании |
| `utm_adcontent` | Контент объявления |
| `utm_keyword` | Ключевое слово, по которому пришёл пользователь |
| `device_category` | Тип устройства: mobile, tablet, desktop |
| `device_os` | Операционная система |
| `device_brand` | Производитель устройства |
| `device_screen_resolution` | Разрешение экрана |
| `device_browser` | Браузер |
| `geo_country` | Страна пользователя |
| `geo_city` | Город пользователя |

### 2. `ga_hits.csv` – логи событий
- **Размер**: 15 708 973 строк, 11 столбцов.
- **Одна строка = одно событие (хит)**.

#### Ключевые атрибуты:
| Поле | Описание |
|------|--------|
| `event_category` | Категория события |
| `event_action` | Действие пользователя |
| `event_label` | Тег действия |
| `event_value` | Значение результата действия |

---

## Подготовка данных

### Очистка и обработка

- **Дубликаты**: полные дубликаты в `ga_sessions.csv` и `ga_hits.csv` не обнаружены.
- **Удаление признака `device_model`**: из-за **99% пропусков** признак был удалён как непригодный для анализа.
- **Обработка пропусков**:
  - `utm_keyword`, `utm_adcontent`, `utm_campaign`, `utm_source`, `utm_medium` – заменены на `'unknown'`;
  - `device_os` – заполнены логически: если `device_brand == 'Apple'` и `device_category` – mobile/tablet → `iOS`, если desktop → `Macintosh`;
  - `device_brand` – определены на основе `device_browser` (например, Safari → Apple, YaBrowser → Yandex);
  - `device_screen_resolution`, `device_browser`, `geo_city`, `geo_country` – пропуски заменены на `'unknown'`.

### Агрегация данных

Поскольку задача – предсказание поведения **пользователя**, а не сессии, данные были агрегированы по `client_id`.

#### Созданы следующие признаки:
- `session_count` – общее количество сессий пользователя;
- `avg_hit_count` – среднее количество хитов за сессию;
- `active_days` – количество дней, в которые пользователь заходил на сайт;
- `first_visit`, `last_visit` – дата первого и последнего визита;
- `avg_days_between` – средний интервал между визитами (в днях);
- `total_target_actions` – бинарная целевая переменная: 1, если пользователь хотя бы раз совершил целевое действие, 0 – если нет.

Итоговый датасет: **1 320 704 уникальных пользователя, 21 признак**.

---

## Разведывательный анализ (EDA)

### Ключевые наблюдения

Анализ данных позволил выявить важные паттерны поведения пользователей сайта «СберАвтоподписка». Ниже представлены основные выводы с интерпретацией визуализаций.

---

### 1. Распределение числовых признаков 
<img width="988" height="989" alt="image" src="https://github.com/user-attachments/assets/348c07b5-b198-4dd0-b97b-515804c94ab7" />



**Интерпретация**:  
Все числовые признаки имеют выраженную правую скошенность, с концентрацией значений у минимума и редкими крупными выбросами. Распределение не является нормальным.

### 2. Поведение большинства пользователей
<img width="1089" height="490" alt="image" src="https://github.com/user-attachments/assets/45efe693-29ea-4bde-9b7d-e2450f4aa679" />
<img width="628" height="548" alt="image" src="https://github.com/user-attachments/assets/28f5a32a-c511-49e2-8965-b7c75f4af779" />



- **Среднее количество сессий**: **1,31**, медиана – **1**.
- **Среднее значение `visit_number`**: **1,37**, медиана – **1**.
- **Максимальное количество визитов у одного пользователя**: **564**.
- **75% пользователей заходят на сайт единожды** и не возвращаются.

**Интерпретация**:  
Поведение пользователей крайне одноразовое. Сайт не удерживает аудиторию. Лишь небольшой сегмент возвращается повторно. Это указывает на **низкую retention rate** и необходимость внедрения механизмов ретаргетинга, email-рассылок и push-уведомлений.

---

### 3. Активность и вовлеченность

- **Среднее количество хитов на пользователя**: **13,99**, медиана – **8**.
- **Максимальное количество хитов**: **500**.
- **75% пользователей вообще не совершают целевых действий**.
- **Среднее значение целевой переменной**: **0,07**.

**Интерпретация**:  
Большинство пользователей проявляют низкую активность, но существуют **"супер-активные" пользователи** с аномально высоким количеством действий. Это создаёт сильную дисперсию: средние значения сильно занижены из-за подавляющего большинства "подсмотрщиков". Конверсия — **6,68%**, что указывает на проблемы в воронке продаж.

---

### 4. Временная активность
<img width="989" height="490" alt="image" src="https://github.com/user-attachments/assets/f98ca869-20bb-4126-82dd-85823043ff10" />
<img width="881" height="554" alt="image" src="https://github.com/user-attachments/assets/468d2a21-8505-47d7-8f82-e016a7c3dda8" />


- **Период анализа**: май — декабрь 2021 года (8 месяцев).
- **Количество активных дней**: медиана — **1**, среднее — **1,14**.
- **Среднее время между сессиями**: медиана и 75%-й перцентиль — **0**, что подтверждает отсутствие возвратов.
- **Пик по месяцам**: **декабрь** — 153 851 визит.
- **Сезон**: **осень** — наиболее активный сезон.
<img width="881" height="554" alt="image" src="https://github.com/user-attachments/assets/3220d311-6798-469b-8996-752aefc03b30" />

- **Пик по дням недели**: **вторник**.
<img width="873" height="555" alt="image" src="https://github.com/user-attachments/assets/060d14a2-a622-4683-9f59-dc6757269917" />


- **Пик по часам**: **14:00**.
- **Активное время суток**: **день (12:00–17:00)**.

**Интерпретация**:  
Активность имеет ярко выраженные временные паттерны. Пик в декабре может быть связан с новогодними планами и маркетинговыми акциями. Рекомендуется концентрировать рекламную активность на **вторник, дневное время и декабрь**.

---

### 5. Каналы трафика (UTM-метки)

- **239 уникальных источников**, но топ-1 (`yandex`) – **37% трафика**.
- **Основной канал**: `banner` – **466 332 сессии** (25%).
- **377 кампаний**, но одна (`LTuZkdKfxRGVceoWkVyg`) – **291 934 сессии (~22%)**.
- **259 объявлений**, но одно – используется в **>50% случаев**.
- **50% значений `utm_keyword`** – `'unknown'`.

**Интерпретация**:  
Трафик **сильно сконцентрирован** на нескольких источниках, кампаниях и объявлениях. Это создаёт **риск зависимости** от узкой группы. Отсутствие данных по ключевым словам указывает на **проблемы с UTM-разметкой** или трекингом. Рекомендуется диверсифицировать каналы и улучшить передачу UTM-параметров.

---

### 6. Устройства и браузеры
<img width="515" height="411" alt="image" src="https://github.com/user-attachments/assets/aa122b90-1bf2-4081-b968-4ea40ea79ac3" />


- **Мобильный трафик**: **80,8%**.
- **Desktop**: **18.3%**.

- **Неизвестная ОС**: **~37% записей** – серьёзная проблема сбора данных.
- **Топ бренд**: **Apple** – около **30%** пользователей.
- **Топ разрешение экрана**: **414x896**.
- **Топ браузер**: **Chrome** – **55,7%**.

**Интерпретация**:  
UX сайта **должен быть адаптирован под мобильные устройства**, особенно под **iPhone**. Низкое качество данных по ОС снижает точность анализа. При тестировании и разработке приоритет — **Chrome**.

---

### 7. География трафика
<img width="597" height="532" alt="image" src="https://github.com/user-attachments/assets/e1563884-b475-401e-9bf2-a902a8739988" />


- **почти 97% трафика** – из **России**. Предполагаем, что оставшиеся 3% тоже их Росии, но через VPN.
- Основные города: Москва (около 41%), Санкт-Петербург. Это говорит о сильном региональном смещении спроса. 


**Интерпретация**:  
Спрос **сильно сконцентрирован в Москве**. Есть потенциал для роста в регионах. Рекомендуется запускать **локализованные рекламные кампании**.

**Анализ корреляции категориальных признаков**:
<img width="925" height="842" alt="image" src="https://github.com/user-attachments/assets/4d4585cc-1fc9-4858-b1e0-797dc4350581" />


## Анализ матрицы Cramér’s V

Проанализируем результаты:

- **UTM-метки** (`source`, `medium`, `campaign`, `adcontent`) демонстрируют сильную взаимосвязь между собой. Это логично, так как эти параметры формируются вместе в рамках одной рекламной кампании. Однако высокая корреляция указывает на **избыточность признаков**, что может ограничивать гибкость маркетинга и затруднять оценку вклада каждого параметра в отдельности.

- **Технические характеристики устройств** (`brand`, `os`, `category`) также логично взаимосвязаны. Например, бренд Apple ассоциируется с iOS и определёнными разрешениями экрана. Эта связь подтверждает корректность данных и ожидаемые паттерны пользовательского поведения.

- **Целевые действия** (`total_target_actions`) не показывают прямой зависимости от источников трафика, типов устройств или временных признаков. Это говорит о том, что конверсия формируется под влиянием комплекса факторов, а не одного отдельного признака.

- **Временные признаки** (`month`, `season`, `time_of_day`) оказывают слабое прямое влияние на совершение целевых действий, однако они тесно связаны с UTM-кампаниями. Это означает, что **сезонность играет ключевую роль в планировании рекламных активностей**, даже если не влияет напрямую на конверсию. Учёт временных паттернов позволяет более эффективно распределять маркетинговый бюджет.

---

### Общие выводы по EDA

1. **Сайт не удерживает пользователей**: 75% – одноразовые визиты. Необходимо внедрять **ретаргетинг и push-напоминания**.
2. **Конверсия крайне низкая – 6,68%**: большинство пользователей не доходят до заявки. Требуется **упрощение процесса оформления**.
3. **Мобильный трафик доминирует – 80,8%**: UX должен быть **максимально адаптирован под мобильные устройства**.
4. **Трафик сконцентрирован на Москве и крупных городах**: рекламные кампании можно **локализовать и персонализировать**.
5. **Пик активности – день, вторник, декабрь**: запускать рекламу в эти периоды для **максимального охвата**.
6. **Основные рекламные кампании и источники перегружены**: стоит **диверсифицировать каналы**.
7. **Данные по ОС и ключевым словам часто неполные**: требуется **улучшение трекинга и аналитики**.

---

## Подготовка данных к моделированию по результатам EDA
<img width="1333" height="997" alt="image" src="https://github.com/user-attachments/assets/44d54f68-5bc1-432c-bfe4-6b56f8029136" />

Перед обучением модели было выполнено комплексное преобразование данных, направленное на повышение их качества, устранение шумов и создание информативных признаков. 

## Анализ важности признаков по модели и матрице Cramér V после подготовки данных к подаче в модель

- **Маркетинговые признаки** (`utm_source`, `utm_medium`, `utm_campaign`, `utm_adcontent`, `utm_keyword`) показали умеренную связь с целевой переменной (**Cramér V ~ 0.1–0.4**). Это объясняет их высокую значимость при построении модели и подчёркивает важность грамотной настройки рекламных кампаний, корректной UTM-разметки и контроля качества трафика.

- **Технические характеристики устройств** (`device_category`, `device_os`, `device_brand`, `device_browser`) вносят значимый вклад в предсказание поведения пользователей. Это согласуется с наблюдением о преобладании мобильного трафика (80,8%) и указывает на необходимость учитывать специфику UX для разных устройств и платформ, особенно в части адаптации интерфейса и оптимизации производительности.

- **Временные признаки** (`month`, `season`, `time_of_day`) демонстрируют статистически значимую связь с поведением пользователей. Выявлены ярко выраженные паттерны: пик активности приходится на **декабрь** (сезон) и **дневное время** (12:00–17:00). Это даёт основу для усиления рекламной активности в определённые временные окна и сезонные периоды.

- **География** (`geo_country`, `geo_city`) в целом влияет слабо, однако **Москва** выделяется как ключевой источник трафика и конверсий. Это подтверждает актуальность локализованных рекламных акций и таргетинга на крупные города.

### Дополнительно
- При разделении данных на обучающую и тестовую выборки планируется использование параметра `stratify=y`. Это обусловлено **значительным дисбалансом классов**: доля пользователей, совершивших целевое действие, составляет всего **6,68%**. Применение стратификации позволяет сохранить пропорции классов в обеих выборках, что критически важно для объективной оценки качества модели.

---

## Моделирование

### Задача
- **Бинарная классификация**: предсказать, совершит ли пользователь целевое действие.
- **Метрика качества**: **ROC-AUC**, ориентир – 0.65+.

### Подход

- **Модель**: **CatBoost** – выбрана из-за высокой интерпретируемости и эффективной работы с категориальными признаками.
- **Разделение выборки**: использовано `stratify=y` для сохранения пропорций классов в условиях сильного дисбаланса.
- **Балансировка классов**: `auto_class_weights='Balanced'`.

### Предобработка признаков

- **Категориальные признаки**: обработаны вручную на основании самых популярных категорий (топ-15/25), приведены к типу `category`.
- **Числовые признаки**: `visit_number`– оставлены как есть.
- **Временные признаки**:
  - `visit_date` → `month`, `weekday`, `hour`;
  - `hour` → `time_of_day` (утро, день, вечер, ночь);
  - `month` → `season` (зима, весна, лето, осень).

---

## Оценка качества модели


### Интерпретация


- **ROC-AUC = 0.73** — модель демонстрирует **умеренно хорошее** качество разделения классов, учитывая сильный дисбаланс.
- **Класс 0 (не совершил действие)**: высокая точность (0.95), но **recall = 0.70** → модель пропускает 30% потенциальных клиентов.
- **Класс 1 (совершил действие)**: **recall = 0.63**, но **precision = 0.17** → модель склонна "перестраховываться", классифицируя в 1 все, что хоть немного похоже на целевое действие.
- **F1 macro = 0.54** — подчёркивает перекос в пользу основного класса, несмотря на балансировку.

### Вывод по модели

Модель справляется с задачей на **приемлемом для начального этапа уровне**, выявляя часть целевых пользователей. Однако есть резервы для улучшения:

1. **Улучшить качество трекинга** (особенно `utm_keyword`, `device_os`);
2. **Проработать фиче-инжиниринг** (например, создать признаки на основе последовательности действий);
3. **Использовать ансамбли**, оптимизированные по **F2-мере** (с акцентом на recall для класса 1).

---

## Интерпретация важности признаков (фичей)

### Анализ по SHAP и PredictionValuesChange





#### 1. Наиболее значимый признак – `visit_number`
- Занимает **первое место по SHAP** и **второе по PredictionValuesChange**.
- Подтверждает гипотезу: **повторные визиты** значительно повышают вероятность конверсии.
- Подчёркивает проблему **низкой удерживаемости**.

#### 2. Маркетинговые признаки
- Группа `utm_` (**source, medium, campaign, adcontent**) стабильно входит в **топ-5**.
- `utm_campaign` – лидер по **PredictionValuesChange** → ключевой рычаг для оптимизации рекламы.

#### 3. География
- `geo_city` – **5–6 место**, в то время как `geo_country` почти не влияет.
- Подчеркивает важность **локального таргетинга**, особенно на **Москву**.

#### 4. Временные признаки
- `month`, `hour`, `time_of_day`, `weekday` – умеренная, но стабильная значимость.
- Подтверждают паттерны: **декабрь**, **вторник**, **дневное время**.

#### 5. Технические признаки
- `device_os`, `device_brand`, `device_category` – меньший вклад, чем у маркетинговых.
- Влияют косвенно, через UX и производительность.

---

## Результаты и рекомендации

### Финальные выводы и рекомендации

#### 1. Оценка эффективности каналов привлечения трафика

Признаки `utm_campaign`, `utm_source` и `utm_medium` входят в топ-5 по значимости в модели, что подтверждает: **качество и структура рекламного трафика напрямую влияют на вероятность конверсии**.

Однако анализ показал:
- **Одна кампания (`LTuZkdKfxRGVceoWkVyg`)** — используется в **>50% случаев**.
- **Топ-3 источника (`yandex`, `google`, `referral`)** — генерируют **более 60% трафика**.
- Это указывает на **сильную зависимость от узкой группы кампаний и источников**, что создаёт риски при их отключении или снижении эффективности.

Рекомендация:
- **Провести аудит эффективности текущих каналов**, оценив конверсию и ROI по каждой кампании.
- **Протестировать новые источники трафика** (например, SMM, контекстную рекламу в регионах, партнёрские программы).
- **Диверсифицировать рекламные каналы** для снижения зависимости и повышения устойчивости маркетинговой стратегии.

---

#### 2. Адаптация рекламных кампаний

Модель выявила значимость признаков `utm_adcontent` и `utm_keyword`, что говорит о важности **конкретного контента объявления и ключевых слов** для привлечения целевой аудитории.

Однако:
- **50% значений `utm_keyword`** — `'unknown'`.
- **259 объявлений**, но одно используется в **>50% случаев**.
- Это указывает на **некачественную UTM-разметку** и **неравномерную нагрузку кампаний**.

Временные признаки (`month`, `hour`, `time_of_day`, `season`) также значимы, но не определяющие:
- Пик активности — **вторник, 14:00, декабрь**.
- Однако сезонность не является ключевым фактором, что говорит о стабильности спроса с возможными всплесками.

Рекомендации:
- **Уточнить и очистить UTM-разметку** — настроить передачу ключевых слов и контента объявлений.
- **Использовать временные пики** (вторник, дневное время, декабрь) при планировании запусков рекламных кампаний.
- **Персонализировать рекламные сообщения** под поведенческие паттерны: например, для пользователей, возвращающихся после первого визита.
- **Запускать A/B-тесты объявлений** с разным контентом и ключевыми словами.

---

#### 3. Улучшение UX сайта за счет анализа поведения пользователей

**Наиболее значимый признак в модели — `visit_number`**. Это означает, что **повторное посещение — главный индикатор готовности к целевому действию**.

Однако:
- **75% пользователей заходят на сайт единожды и не возвращаются**.
- **Среднее количество активных дней — 1,14**, медиана — 1.
- Это указывает на **критически низкую удерживаемость (retention)**.

Дополнительные наблюдения:
- **80,8% трафика — с мобильных устройств**.
- **97% трафика — из России**, **41% — из Москвы**.
- Конверсия с мобильных ниже, чем с desktop.

Рекомендации:
- **Сделать повторные визиты основной целью UX-оптимизации**:
  - Внедрить **push-уведомления** и **email-рассылки** с напоминаниями.
  - Настроить **ретаргетинг** для пользователей, не завершивших заявку.
- **Упростить путь до целевого действия на первом посещении**:
  - Сократить количество шагов.
  - Улучшить **адаптивность мобильной версии** (скорость, вёрстка, формы).
- **Провести A/B-тесты**:
  - Для разных устройств (mobile vs desktop).
  - Для разных регионов (Москва vs регионы).
  - Для сегментов (новые vs возвращающиеся пользователи).
- **Добавить чат-бот или онлайн-поддержку** для помощи в режиме реального времени.---

## Использованные библиотеки

```python
pandas
numpy
matplotlib
seaborn
scikit-learn
catboost
flask
shap
joblib
```
---

## Лицензия

Проект распространяется под лицензией **MIT** — см. файл `LICENSE`.

---

## Инструкция по использованию

1. Загружаем обученную модель CatBoost в директорию с ноутбуком. 
2. Загружаем данные, по которым требуется получить результаты, в подходящем формате. 
3. Запускаем выполнение ноутбука. Результатом является массив с предсказаниями.

## Приложения

- [x] `ipynb` – полный анализ с EDA и ML
- [x] `script.ipynb` – скрипт предсказания
- [x] `catboost_model.cbm` – предобученная модель
- [x] `ga_sessions_example.csv` – пример данных для скрипта
- [x] `README.md` – документация
- [x] `LICENSE` – лицензия
```


